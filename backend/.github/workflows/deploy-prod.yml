name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag to deploy'
        required: true
      migration_required:
        description: 'Run database migrations?'
        required: true
        type: boolean
        default: false

env:
  GO_VERSION: '1.24.0'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/rtx-backend

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify image exists
        run: |
          docker login ${{ env.REGISTRY }} -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.tag }}

      - name: Run security scan on production image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Validate Kubernetes manifests
        run: |
          kubectl apply --dry-run=client -f k8s/ || exit 1

  deploy-blue:
    name: Deploy Blue Environment
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment:
      name: production-blue
      url: https://blue.rtx-trading.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$(pwd)/kubeconfig" >> $GITHUB_ENV

      - name: Create Docker registry secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=rtx-prod \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Backup current deployment
        run: |
          kubectl get deployment rtx-backend-blue -n rtx-prod -o yaml > blue-backup.yaml || true
          kubectl get deployment rtx-backend-green -n rtx-prod -o yaml > green-backup.yaml || true

      - name: Run database migrations
        if: ${{ github.event.inputs.migration_required == 'true' }}
        run: |
          chmod +x scripts/deploy/run-migrations.sh
          ./scripts/deploy/run-migrations.sh production

      - name: Deploy to Blue
        run: |
          kubectl set image deployment/rtx-backend-blue \
            rtx-backend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.tag }} \
            -n rtx-prod

          kubectl rollout status deployment/rtx-backend-blue -n rtx-prod --timeout=15m

      - name: Health check Blue
        run: |
          chmod +x scripts/deploy/health-check.sh
          ./scripts/deploy/health-check.sh https://blue.rtx-trading.com

      - name: Upload deployment backup
        uses: actions/upload-artifact@v4
        with:
          name: deployment-backup
          path: |
            blue-backup.yaml
            green-backup.yaml
          retention-days: 30

  smoke-test-blue:
    name: Smoke Test Blue Environment
    runs-on: ubuntu-latest
    needs: deploy-blue
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run smoke tests
        run: |
          chmod +x scripts/deploy/smoke-test.sh
          ./scripts/deploy/smoke-test.sh https://blue.rtx-trading.com

      - name: Run load test
        run: |
          chmod +x scripts/deploy/load-test.sh
          ./scripts/deploy/load-test.sh https://blue.rtx-trading.com 100

  switch-traffic:
    name: Switch Traffic to Blue
    runs-on: ubuntu-latest
    needs: smoke-test-blue
    environment:
      name: production
      url: https://rtx-trading.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$(pwd)/kubeconfig" >> $GITHUB_ENV

      - name: Switch service to Blue
        run: |
          kubectl patch service rtx-backend -n rtx-prod -p '{"spec":{"selector":{"version":"blue"}}}'

      - name: Monitor metrics for 5 minutes
        run: |
          sleep 300
          chmod +x scripts/deploy/check-metrics.sh
          ./scripts/deploy/check-metrics.sh production

      - name: Verify production traffic
        run: |
          chmod +x scripts/deploy/health-check.sh
          ./scripts/deploy/health-check.sh https://rtx-trading.com

  deploy-green:
    name: Update Green Environment
    runs-on: ubuntu-latest
    needs: switch-traffic
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$(pwd)/kubeconfig" >> $GITHUB_ENV

      - name: Update Green to match Blue
        run: |
          kubectl set image deployment/rtx-backend-green \
            rtx-backend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.tag }} \
            -n rtx-prod

          kubectl rollout status deployment/rtx-backend-green -n rtx-prod --timeout=15m

  notify:
    name: Notify Stakeholders
    runs-on: ubuntu-latest
    needs: [deploy-blue, switch-traffic, deploy-green]
    if: always()
    steps:
      - name: Notify Slack
        uses: slackapi/slack-github-action@v2
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "${{ job.status == 'success' && 'ðŸš€' || 'âŒ' }} Production deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment ${{ job.status }}*\n*Image Tag:* ${{ github.event.inputs.tag }}\n*Migration:* ${{ github.event.inputs.migration_required }}\n*Triggered by:* ${{ github.actor }}\n*Workflow:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }

      - name: Create deployment record
        if: success()
        run: |
          echo "Deployment completed successfully at $(date)" > deployment-record.txt
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.tag }}" >> deployment-record.txt
          echo "Deployed by: ${{ github.actor }}" >> deployment-record.txt

      - name: Upload deployment record
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-record
          path: deployment-record.txt
          retention-days: 90
