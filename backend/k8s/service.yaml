apiVersion: v1
kind: Service
metadata:
  name: rtx-backend
  namespace: rtx-prod
  labels:
    app: rtx-backend
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
spec:
  type: LoadBalancer
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP

    - name: https
      port: 443
      targetPort: 8080
      protocol: TCP

    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP

  selector:
    app: rtx-backend

---
apiVersion: v1
kind: Service
metadata:
  name: rtx-backend-internal
  namespace: rtx-prod
  labels:
    app: rtx-backend
spec:
  type: ClusterIP
  clusterIP: None

  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP

    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP

  selector:
    app: rtx-backend

---
# Blue-Green Services
apiVersion: v1
kind: Service
metadata:
  name: rtx-backend-blue
  namespace: rtx-prod
  labels:
    app: rtx-backend
    version: blue
spec:
  type: ClusterIP

  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP

    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP

  selector:
    app: rtx-backend
    version: blue

---
apiVersion: v1
kind: Service
metadata:
  name: rtx-backend-green
  namespace: rtx-prod
  labels:
    app: rtx-backend
    version: green
spec:
  type: ClusterIP

  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP

    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP

  selector:
    app: rtx-backend
    version: green

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rtx-backend
  namespace: rtx-prod
  labels:
    app: rtx-backend

---
# RBAC Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rtx-backend-role
  namespace: rtx-prod
rules:
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list", "watch"]

  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]

---
# RBAC RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rtx-backend-rolebinding
  namespace: rtx-prod
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rtx-backend-role
subjects:
  - kind: ServiceAccount
    name: rtx-backend
    namespace: rtx-prod
